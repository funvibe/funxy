// =============================================
// OptionalSemantics<F> â€” custom trait with Optional semantics
// Tests that user-defined traits work correctly with types
// where inner type is NOT at Args[0]
// =============================================

// Custom trait with Optional-like semantics
trait OptionalSemantics<f> {
    fun semIsEmpty(v: f<a>) -> Bool
    fun semUnwrap(v: f<a>) -> a
    fun semWrap(val: a) -> f<a>

    // Default: getOrElse derived from isEmpty and unwrap
    fun semGetOrElse(v: f<a>, fallback: a) -> a {
        if semIsEmpty(v) { fallback }
        else { semUnwrap(v) }
    }
}

// Custom type where inner type is at Args[1], NOT Args[0]
// Validated<E, A> - E is error type, A is value type
type Validated<e, a> = Invalid e | Valid a

// Implement OptionalSemantics for Validated
// unwrap signature: Validated<E, A> -> A shows inner type is A (Args[1])
instance OptionalSemantics Validated<e> {
    fun semIsEmpty(v: Validated<e, a>) -> Bool {
        match v {
            Invalid(_) -> true
            Valid(_) -> false
        }
    }

    fun semUnwrap(v: Validated<e, a>) -> a {
        match v {
            Invalid(_) -> panic("semUnwrap on Invalid")
            Valid(val) -> val
        }
    }

    fun semWrap(val: a) -> Validated<e, a> {
        Valid(val)
    }
}

// Test values - inner type is Int (Args[1]), NOT String (Args[0])
val1: Validated<String, Int> = Valid(42)
val2: Validated<String, Int> = Invalid("error")

// Test semIsEmpty
print(semIsEmpty(val1))          // false
print(semIsEmpty(val2))          // true

// Test semUnwrap (only on Valid)
print(semUnwrap(val1))           // 42

// Test semWrap
val3 = semWrap(100) : Validated<String, Int>
print(val3)                      // Valid(100)

// Test semGetOrElse (default implementation)
// This proves type inference correctly extracts Int as inner type
print(semGetOrElse(val1, 0))     // 42
print(semGetOrElse(val2, 0))     // 0

// Test with different inner types
valA: Validated<Int, String> = Valid("hello")
valB: Validated<Int, String> = Invalid(404)

print(semIsEmpty(valA))          // false
print(semIsEmpty(valB))          // true
print(semUnwrap(valA))           // hello
print(semGetOrElse(valA, "default"))  // hello
print(semGetOrElse(valB, "default"))  // default

print("OptionalSemantics test passed!")
