import "lib/test" (testRun, assertEquals, assertTrue)

// Helper to collect range into list
// Range is iterable via built-in Iter instance
fun collect<t>(r: Range<t>) -> List<t> {
    res = []
    for x in r {
        res = res ++ [x]
    }
    res
}

testRun("Ranges: Basic Integer", \ -> {
    // Inclusive end: 1..5 -> [1, 2, 3, 4, 5]
    assertEquals([1, 2, 3, 4, 5], collect(1..5), "1..5 should be [1, 2, 3, 4, 5]")

    // Single element range
    assertEquals([1, 2], collect(1..2), "1..2 should be [1, 2]")

    // Equal start/end
    assertEquals([1], collect(1..1), "1..1 should be [1]")
})

testRun("Ranges: Integer with Step", \ -> {
    // (Start, Next)..End
    // Step = Next - Start = 3 - 1 = 2
    // 1, 3, 5, 7, 9. Next is 11 > 10.
    assertEquals([1, 3, 5, 7, 9], collect((1, 3)..10), "(1, 3)..10")

    // Step = 5
    assertEquals([0, 5, 10], collect((0, 5)..11), "(0, 5)..11")

    // Step = 5, End = 10 (Inclusive) -> [0, 5, 10]
    assertEquals([0, 5, 10], collect((0, 5)..10), "(0, 5)..10")
})

testRun("Ranges: Descending", \ -> {
    // Step = 4 - 5 = -1
    // 5, 4, 3, 2, 1, 0. Next is -1. End is 0.
    // Logic: if step < 0, loop while curr >= end.
    assertEquals([5, 4, 3, 2, 1, 0], collect((5, 4)..0), "(5, 4)..0")

    // Step = -2
    // 10, 8, 6, 4, 2, 0. Next -2. End 0.
    assertEquals([10, 8, 6, 4, 2, 0], collect((10, 8)..0), "(10, 8)..0")
})

testRun("Ranges: Char", \ -> {
    // 'a'..'d' -> ['a', 'b', 'c', 'd']
    assertEquals(['a', 'b', 'c', 'd'], collect('a'..'d'), "'a'..'d'")
})

testRun("Ranges: Char with Step", \ -> {
    // 'a', 'c' .. 'f' -> ['a', 'c', 'e'] (e is next, g is after e, g > f)
    assertEquals(['a', 'c', 'e'], collect(('a', 'c')..'f'), "('a', 'c')..'f'")
})

testRun("Ranges: Empty", \ -> {
    // Start > End with positive step
    assertEquals([], collect(5..1), "5..1 should be empty (default step 1)")

    // Start < End with negative step
    assertEquals([], collect((1, 0)..5), "(1, 0)..5 should be empty because step is -1, start < end")
})

testRun("Ranges: Variables", \ -> {
    start = 1
    end = 5
    assertEquals([1, 2, 3, 4, 5], collect(start..end), "Variable bounds")

    next = 3
    assertEquals([1, 3, 5, 7, 9], collect((start, next)..10), "Variable step")
})

testRun("Ranges: Nested Loops", \ -> {
    res = []
    for i in 1..2 {
        for j in 1..2 {
            res = res ++ [(i, j)]
        }
    }
    assertEquals([(1, 1), (1, 2), (2, 1), (2, 2)], res, "Nested ranges")
})
