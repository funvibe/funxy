import "kit/ui" (*)
import "lib/test" (*)
import "lib/string" (stringIndexOf)
import "lib/tuple" (fst, snd)

fun containsStr(needle, haystack) {
    match stringIndexOf(haystack, needle) {
        Some(_) -> true
        Zero -> false
    }
}

testRun("UI Package - Types", fun() {
    t = text("Hello")
    s = showVNode(t)
    assert(s |> containsStr("Text"), "contains Text constructor")
    assert(s |> containsStr("Hello"), "contains content")
})

testRun("UI Package - Render", fun() {
    node = div(class: "container", id: "main") {
        h1() { text("Title") }
        p(style: "color: red") { text("Content") }
        raw("<span>Raw rendered</span>")
    }

    rendered = render(node)

    assert(rendered |> containsStr("<div"), "contains <div")
    assert(rendered |> containsStr("class=\"container\""), "contains class")
    assert(rendered |> containsStr("id=\"main\""), "contains id")
    assert(rendered |> containsStr("<h1>Title</h1>"), "contains h1")
    assert(rendered |> containsStr("<p style=\"color: red\">Content</p>"), "contains p")
    assert(rendered |> containsStr("<span>Raw rendered</span>"), "contains raw")
    assert(rendered |> containsStr("</div>"), "contains closing div")
})

testRun("UI Package - Void Tags", fun() {
    imgNode = img(src: "pic.jpg", alt: "Pic")
    rendered = render(imgNode)

    assert(rendered |> containsStr("<img"), "contains <img")
    assert(rendered |> containsStr("src=\"pic.jpg\""), "contains src")
    assert(rendered |> containsStr(" />"), "self-closing")
})

testRun("UI Package - Attributes Normalization", fun() {
    btn = button(hx_post: "/api/click", data_val: "123") { text("Click") }
    rendered = render(btn)

    assert(rendered |> containsStr("hx-post=\"/api/click\""), "hx-post present")
    assert(rendered |> containsStr("data-val=\"123\""), "data-val present")
    assert(rendered |> containsStr("Click"), "contains text")
    assert(!(rendered |> containsStr("'")), "no extra quotes")
})

testRun("UI Package - Empty Element", fun() {
    empty = div()
    rendered = render(empty)
    assert(rendered |> containsStr("<div></div>"), "empty div")
})

testRun("UI Package - Block Syntax Without Parens", fun() {
    // Testing clean DSL: div { ... } instead of div() { ... }
    node = div {
        text("Hello")
        span { text("World") }
    }
    rendered = render(node)

    assert(rendered |> containsStr("<div>"), "contains open div")
    assert(rendered |> containsStr("Hello"), "contains text")
    assert(rendered |> containsStr("<span>World</span>"), "contains nested span")
    assert(rendered |> containsStr("</div>"), "contains close div")
})
